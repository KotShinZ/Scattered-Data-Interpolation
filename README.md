# Scattered-Data-Interpolation

散布データ補間

## プロジェクト概要

外部ライブラリに依存せずに 3 次元散布データ補間手法を比較する Python スクリプトを収録しています。SciPy や scikit-learn を利用できない環境でも実行できるよう、線形代数計算から補間アルゴリズムまで標準ライブラリで実装しています。

## 使い方

```bash
python src/compare_interpolation.py
```

実行すると以下の成果物が生成されます。

- `data/dummy_3d_points.csv`: sin 波ベースに小さなノイズを加えた 10 点の 3 次元散布データセット。
- `output/results_summary.csv`: 各補間法の RMSE、1 次滑らかさ、2 次滑らかさ指標。
- `output/interpolation_comparison.svg`: 上記指標を可視化した棒グラフ。

コンソールには各手法の要約が表示され、精度と滑らかさを比較できます。

## 実装されている補間手法

以下の補間器を同じインターフェースで比較できるように実装しています。いずれも純 Python 実装で、外部ライブラリに依存していません。

### 最近傍補間 (Nearest Neighbor)

各予測点に最も近い元データの観測値をそのまま割り当てるシンプルな補間です。値の変化は滑らかにならず、階段状のサーフェスになりますが、高速で外れ値にも強い特性があります。初期状態の基準として役立ちます。

### k 近傍（平均）補間 (K-Neighbors Averaging)

指定した近傍数 \(k\) に含まれるサンプルの単純平均を予測値とする手法です。最近傍より滑らかですが、境界付近ではデータ密度に左右されるため、平坦化しすぎる場合があります。本プロジェクトでは \(k=3\) を既定値としています。

### 逆距離加重 (Inverse Distance Weighting)

各近傍の距離の逆数を重みとして平均を計算し、近い点ほど予測に強く影響するようにした補間です。距離の二乗に基づく重みづけを採用し、局所的な変化を再現しやすいのが特徴です。

### グローバル平面補間 (Global Linear Regression)

全データを一度に使用して三変数一次式 \(f(x, y, z) = ax + by + cz + d\) をフィットし、その式で空間全域を補間します。最も滑らかな結果が得られますが、非線形な構造は表現できないため、大域的な傾向の把握に向いています。

### 放射基底関数補間 (Radial Basis Function)

中心となる各サンプルからの距離に依存する基底関数を足し合わせて値を推定する手法です。以下のカーネルをサポートし、局所的な変化から滑らかな変動まで調整できます。

- `linear` — 距離に比例して値を変化させる線形カーネル。
- `cubic` — 距離の 3 乗で滑らかさと曲率を両立するカーネル。
- `quintic` — より高次の滑らかさを確保する 5 次カーネル。
- `gaussian` — ガウス型で急峻なピークを再現しやすいカーネル。
- `multiquadric` — 距離の二乗と定数の平方根で構成される滑らかなカーネル。
- `inverse_multiquadric` — multiquadric の逆で、遠方の影響を抑えやすいカーネル。

### 薄板スプライン (Thin-Plate Spline)

曲率（2 次微分）の二乗積分を最小化することで、薄い金属板を曲げたような滑らかなサーフェスを生成する補間です。適切なスムージング係数を選ぶことでノイズを抑えつつ、全体的な形状を忠実に再現できます。

### ガウス過程回帰 (Gaussian Process Regression)

確率的なカーネル回帰により、予測値だけでなく不確実性もモデル化する手法です。本実装では等方的な平方指数カーネルを使用し、滑らかで連続的なサーフェスを得ています。ハイパーパラメータはベイズ的最尤推定で自動調整されます。

### オーディナリークリギング (Ordinary Kriging)

空間統計に基づく補間で、観測値の空間自己相関（セミバリオグラム）から最適な重みを求めます。平均値が一定であるという仮定のもと、局所的な変動を反映した推定が可能です。

### ユニバーサルクリギング (Universal Kriging)

オーディナリークリギングを拡張し、位置に応じて変化するトレンド成分（一次ドリフト）を明示的にモデル化します。大域的な傾向と局所的な変化を同時に捉えたい場合に有効です。

## GitHub Pages での実行

リポジトリを GitHub に配置した状態で、ブラウザ上だけで補間処理を実行して結果を確認することもできます。

1. GitHub リポジトリの設定で **Pages** を有効化し、ビルド元に `main` ブランチの `docs/` ディレクトリを指定します。
2. デプロイ完了後に公開 URL へアクセスすると `docs/index.html` がロードされます。初期状態ではいずれのデータも学習されていないため、以下のいずれかの操作で学習データを読み込んでください。
   - 「CSV をインポート」で <code>x,y,z,value</code> 列を含むファイルを選択すると、その時点で Pyodide 上の Python が全補間器を学習します。
   - 付属のサンプルを使う場合は「ダミーデータを使用」ボタンを押します。
   - 以前アップロードした CSV が `localStorage` に保存されている場合は、「保存済みデータを読み込む」ボタンが現れます。これを押すとブラウザに保存してあるデータセットを再学習できます（再アップロード不要）。
   いずれかのデータを読み込むまでは学習も predict も走りません。データを切り替えたときは自動的に再学習が行われ、最新のモデルがキャッシュされます。
3. ステータスが「学習が完了しました」と表示されたら「結果を計算」ボタンで predict のみを実行し、表・棒グラフと 3D サーフェスを描画します。
   Pyodide は Web Worker 内で動作するため、predict 実行中でも UI が固まらず、各種コントロールを操作できます。
   ドロップダウンで固定する軸（X/Y/Z）と固定値を指定すると、その平面で補間した結果が描画されます。
   「元データの点サイズ」入力で散布データのマーカーサイズを調整できます。補間サーフェスとの位置関係を確認しやすい値に変更してください。
   「サーフェスで元データを隠す」チェックボックスを有効にすると、補間サーフェスを不透明に描画し、手前にあるサーフェスで元データの点群を隠すことができます。
4. 読み込んだ CSV はブラウザの `localStorage` に保存されるため、`line.html` など別ページでも「保存済みデータを読み込む」ボタンから同じデータセットを再学習できます。別の CSV をインポートするか「ダミーデータを使用」を押すと保存内容も更新／削除されます。

GitHub Pages 版では **データを読み込んだタイミングで Pyodide 上の Python がすべての補間器を学習（fit）し、その結果をキャッシュ** します。
ブラウザ側ではこの処理と predict を Web Worker 経由で行うため、重い処理の最中でも UI スレッドがブロックされません。
「結果を計算」ボタンは、キャッシュ済みのモデルに対して指定した軸・固定値で **predict のみ** を実行し、サーフェス描画に必要な平面スライスを取得します。
CSV を切り替えたり「ダミーデータを使用」ボタンを押した場合は自動的に再学習が走り、その後のボタン操作では新しい学習結果を使った平面予測だけが行われます。

Pyodide は `docs/compare_interpolation.py`（ローカルの `src/compare_interpolation.py` と同一内容）をブラウザ内に読み込んで実行するため、GitHub Pages 上でもローカルと同じ純 Python 実装を利用できます。両者を更新した際は内容が一致するようにしてください。

### 2 軸を固定したラインビュー（`docs/line.html`）

GitHub Pages では平面サーフェスビューに加えて、2 軸を固定し残り 1 軸方向の補間値を折れ線で比較する `line.html` も公開されます（ローカルでも `docs/line.html` を直接ブラウザで開けます）。

1. CSV をインポートするか「ダミーデータを使用」「保存済みデータを読み込む」のいずれかを押すと自動で全手法の学習が行われ、RMSE/滑らかさサマリーがテーブルに表示されます。
2. 「変化させる軸」で X/Y/Z のいずれかを選び、残り 2 軸の入力欄に固定値を設定します（データ範囲の中央値が初期値です）。
3. 「ラインを計算」ボタンは学習済みモデルに対して **predict のみ** を実行し、指定した固定値での 1 次元ライン上の予測値を各補間法ごとに折れ線グラフで描画します。すべてのグラフには元データの散布図を重ねて表示するため、アップロードした値と補間曲線のズレをその場で確認できます。
4. CSV インポートや「ダミーデータを使用」「保存済みデータを読み込む」ボタンの挙動は `index.html` と同じで、データが変わるたびに再学習が走ります。
   いずれかのページで読み込んだ CSV は共有ストレージに保存され、`index.html`/`line.html` の双方で同じ「保存済みデータを読み込む」ボタンから利用できます。

ラインビューは 3D サーフェスより軽量で、特定の断面に沿った値の遷移を詳しく確認したい場合に便利です。ページ上部のリンクから 3D サーフェス表示と行き来できます。

## 固定平面での可視化の流れ

ブラウザで表示しているサーフェスは、Python 側で 3 次元の補間器を学習した後、指定した軸を入力値で固定した平面上で再度補間（predict）して得られた結果です。UI ではこの平面上の格子点と補間値を受け取り、サーフェスとして描画します。

1. Python で全ての手法について訓練を行い、評価用の 3 次元グリッドとメトリクスを計算します。
2. ユーザーが選択した軸（X/Y/Z）と固定値を用いて、残り 2 軸で構成される格子を生成し、その平面上で補間値を予測します。
3. ブラウザは受け取った格子点・補間値を 3D サーフェスとして描画し、元の散布データは座標や値を変更せず点群として重ね表示します（UI の切り替えでサーフェスを不透明化すると、サーフェスの背後にある点群は隠れるように描画されます）。

このため、入力データの数値を書き換えることなく、任意の平面での補間結果を直接確認できます。固定値を変更したい場合は UI の入力欄を編集し、再度「結果を計算」ボタンを押してください。
